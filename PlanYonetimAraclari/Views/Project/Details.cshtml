@model PlanYonetimAraclari.Models.ProjectDetailViewModel
@using PlanYonetimAraclari.Extensions
@{
    ViewData["Title"] = "Proje Detayları - " + Model.Project.Name;
    Layout = "~/Views/Shared/_Layout.cshtml";
    bool canModifyTasks = ViewBag.CanModifyTasks;
}

<!-- Üst Bilgi Alanı -->
<div class="p-6">
    <div class="mb-6 flex justify-between items-center">
        <div>
            <div class="flex items-center">
                <a href="@Url.Action("Index", "Dashboard")" class="text-gray-500 hover:text-primary-500 mr-3">
                    <i class="fas fa-arrow-left"></i>
                </a>
                <h1 class="text-2xl font-bold text-gray-900">@Model.Project.Name</h1>
                <span class="ml-3 px-3 py-1 @(Model.Project.Status == ProjectStatus.Planning ? "bg-blue-100 text-blue-800" : 
                                           Model.Project.Status == ProjectStatus.InProgress ? "bg-amber-100 text-amber-800" : 
                                           Model.Project.Status == ProjectStatus.Completed ? "bg-green-100 text-green-800" :
                                           Model.Project.Status == ProjectStatus.OnHold ? "bg-gray-100 text-gray-800" :
                                           "bg-red-100 text-red-800") text-xs rounded-full">
                    @(Model.Project.Status == ProjectStatus.Planning ? "Planlama" : 
                     Model.Project.Status == ProjectStatus.InProgress ? "Devam Ediyor" : 
                     Model.Project.Status == ProjectStatus.Completed ? "Tamamlandı" :
                     Model.Project.Status == ProjectStatus.OnHold ? "Beklemede" :
                     "İptal Edildi")
                </span>
            </div>
            <p class="text-sm text-gray-600 mt-1">Oluşturulma: @Model.Project.CreatedDate.ToString("dd MMMM yyyy")</p>
        </div>
        
        <div class="flex space-x-4">
            <a href="@Url.Action("Members", "Team", new { projectId = Model.Project.Id })" class="inline-flex items-center px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition-colors">
                <i class="fas fa-users mr-2"></i>
                Ekip Üyeleri
            </a>
            @if (Model.Project.UserId == ViewBag.CurrentUserId || (ViewBag.UserRole != null && ViewBag.UserRole == TeamMemberRole.Manager))
            {
                <a href="@Url.Action("Edit", "Project", new { id = Model.Project.Id })" class="inline-flex items-center px-4 py-2 bg-gray-600 text-white rounded-md hover:bg-gray-700 transition-colors">
                    <i class="fas fa-edit mr-2"></i>
                    Düzenle
                </a>
            }
            @if (Model.Project.UserId == ViewBag.CurrentUserId)
            {
                <button type="button" id="delete-project-btn" class="inline-flex items-center px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700 transition-colors">
                        <i class="fas fa-trash-alt mr-2"></i>
                        Sil
                    </button>
                @Html.AntiForgeryToken()
            }
            else if (ViewBag.CanModifyTasks && Model.Project.UserId != ViewBag.CurrentUserId)
            {
                <button type="button" id="leave-project-btn" class="inline-flex items-center px-4 py-2 bg-yellow-600 text-white rounded-md hover:bg-yellow-700 transition-colors">
                    <i class="fas fa-sign-out-alt mr-2"></i>
                    Projeden Ayrıl
                </button>
            }
        </div>
    </div>
    
    <!-- Bildirim Mesajları -->
    @if (TempData["SuccessMessage"] != null)
    {
        <div class="bg-green-50 border-l-4 border-green-500 p-4 mb-6 auto-hide-message">
            <div class="flex">
                <div class="flex-shrink-0">
                    <i class="fas fa-check-circle text-green-500"></i>
                </div>
                <div class="ml-3">
                    <p class="text-sm text-green-700">@TempData["SuccessMessage"]</p>
                </div>
            </div>
        </div>
    }
    
    @if (TempData["ErrorMessage"] != null)
    {
        <div class="bg-red-50 border-l-4 border-red-500 p-4 mb-6 auto-hide-message">
            <div class="flex">
                <div class="flex-shrink-0">
                    <i class="fas fa-exclamation-circle text-red-500"></i>
                </div>
                <div class="ml-3">
                    <p class="text-sm text-red-700">@TempData["ErrorMessage"]</p>
                </div>
            </div>
        </div>
    }
    
    <!-- Proje Detayları -->
    <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100 mb-8">
        <h2 class="text-lg font-semibold text-gray-900 mb-3">Proje Detayları</h2>
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div>
                <div class="mb-4">
                    <h3 class="text-sm font-medium text-gray-500">Açıklama</h3>
                    <p class="text-gray-700">@(string.IsNullOrEmpty(Model.Project.Description) ? "Açıklama yok" : Model.Project.Description)</p>
                </div>
                
                <div class="mb-4">
                    <h3 class="text-sm font-medium text-gray-500">Başlangıç Tarihi</h3>
                    <p class="text-gray-700">@Model.Project.StartDate.ToString("dd MMMM yyyy")</p>
                </div>
                
                <div>
                    <h3 class="text-sm font-medium text-gray-500">Bitiş Tarihi</h3>
                    <p class="text-gray-700">@Model.Project.EndDate.ToString("dd MMMM yyyy")</p>
                </div>
            </div>
            
            <div>
                <div class="mb-4">
                    <h3 class="text-sm font-medium text-gray-500">Son Güncelleme</h3>
                    <p class="text-gray-700">@(Model.Project.LastUpdatedDate.HasValue ? Model.Project.LastUpdatedDate.Value.ToString("dd MMMM yyyy HH:mm") : "Güncellenmemiş")</p>
                </div>
                
                <div class="mb-4">
                    <h3 class="text-sm font-medium text-gray-500">Tamamlanma Durumu</h3>
                    <div class="mt-2 flex items-center">
                        <div class="w-full bg-gray-200 rounded-full h-2 mr-2">
                            <div class="bg-primary-500 h-2 rounded-full" style="width: @Model.CompletionPercentage%"></div>
                        </div>
                        <span class="text-sm text-gray-500">%@Model.CompletionPercentage</span>
                    </div>
                </div>

                <div>
                    <h3 class="text-sm font-medium text-gray-500">Ekip Üyeleri</h3>
                    <div class="mt-2 space-y-2">
                        @if (Model.TeamMembers != null && Model.TeamMembers.Any())
                        {
                            foreach (var member in Model.TeamMembers.Take(3))
                            {
                                <div class="flex items-center space-x-2">
                                    @if (!string.IsNullOrEmpty(member.UserProfileImage))
                                    {
                                        <img src="@member.UserProfileImage" alt="@member.UserFullName" class="w-6 h-6 rounded-full">
                                    }
                                    else
                                    {
                                        <div class="w-6 h-6 rounded-full bg-gray-300 flex items-center justify-center">
                                            <span class="text-xs text-gray-600 font-semibold">@member.UserFullName.Substring(0, 1)</span>
                                        </div>
                                    }
                                    <span class="text-sm text-gray-700">@member.UserFullName</span>
                                    <span class="text-xs text-gray-500">(@(member.Role.ToString() == "Owner" ? "Üye" : member.Role.ToString()))</span>
                                </div>
                            }
                            @if (Model.TeamMembers.Count > 3)
                            {
                                <div class="text-sm text-gray-500">
                                    ve @(Model.TeamMembers.Count - 3) kişi daha...
                                </div>
                            }
                        }
                        else
                        {
                            <p class="text-sm text-gray-500">Henüz ekip üyesi yok</p>
                        }
                        <div class="mt-2">
                            <a href="@Url.Action("Members", "Team", new { projectId = Model.Project.Id })" class="text-sm text-primary-600 hover:text-primary-800">
                                Tüm üyeleri görüntüle
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Görevler Bölümü (Trello-like) -->
    <div class="mb-8">
        <div class="flex justify-between items-center mb-4">
            <h2 class="text-lg font-semibold text-gray-900">Görevler</h2>
            
            <!-- Yardım butonu ve ipucu -->
            <div class="relative" id="tasks-help-container">
                <button id="tasks-help-button" class="text-gray-500 hover:text-primary-500 focus:outline-none">
                    <i class="fas fa-question-circle text-xl"></i>
                </button>
                <div id="tasks-help-content" class="absolute right-0 mt-2 w-80 bg-white rounded-md shadow-lg py-4 px-4 hidden z-10">
                    <h3 class="font-medium text-gray-800 mb-2">Görevleri Taşıma ve Düzenleme Yardımı</h3>
                    <ul class="text-sm text-gray-600 space-y-2">
                        <li class="flex items-start">
                            <i class="fas fa-arrows-alt text-primary-500 mt-1 mr-2"></i>
                            <span>Görevleri <strong>sürüklerek bırakarak</strong> farklı durumlara taşıyabilirsiniz.</span>
                        </li>
                        <li class="flex items-start">
                            <i class="fas fa-arrow-right text-primary-500 mt-1 mr-2"></i>
                            Veya görev kartlarındaki <strong>ok butonlarını</strong> kullanarak taşıyabilirsiniz.</li>
                        <li class="flex items-start">
                            <i class="fas fa-trash-alt text-red-500 mt-1 mr-2"></i>
                            <span>Görev silmek için kart üzerindeki <strong>çöp kutusu</strong> simgesine tıklayın.</span>
                        </li>
                    </ul>
                </div>
            </div>
        </div>
        
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
            <!-- Todo Tasks -->
            <div class="bg-white rounded-lg shadow p-4 flex flex-col">
                <div class="flex justify-between items-center mb-4">
                    <div class="flex items-center">
                        <h3 class="text-lg font-semibold text-gray-800">Yapılacaklar</h3>
                        @if (canModifyTasks)
                        {
                            <button class="quick-add-task-btn ml-2 text-green-500 hover:text-green-700 transition-colors" data-status="0" data-project-id="@Model.Project.Id">
                                <i class="fas fa-plus-circle text-lg"></i>
                            </button>
                        }
                </div>
                    <span class="bg-blue-100 text-blue-800 text-xs font-medium px-2.5 py-0.5 rounded-full todo-count-badge" id="todo-count">@Model.TodoTasks.Count</span>
                </div>
                <div id="todo-tasks" class="task-container space-y-3 min-h-[200px] p-2 rounded-lg border-2 border-dashed border-blue-100 border-opacity-0 transition-all hover:border-opacity-100 overflow-y-auto flex-grow">
                    @foreach (var task in Model.TodoTasks)
                    {
                        <div class="task-card bg-white rounded-lg border border-gray-200 p-3 shadow-sm hover:shadow-md transition-shadow duration-200 cursor-grab active:cursor-grabbing" data-task-id="@task.Id">
                            <div class="flex justify-between items-start">
                                <h4 class="font-medium text-gray-800 mb-1">@task.Name</h4>
                                @if (canModifyTasks)
                                {
                                <div class="task-actions ml-2 flex items-center">
                                    <button class="edit-task-btn text-blue-500 hover:text-blue-700 mr-2" data-task-id="@task.Id">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button class="delete-task-btn text-red-500 hover:text-red-700" data-task-id="@task.Id">
                                        <i class="fas fa-trash-alt"></i>
                                    </button>
                                </div>
                                }
                            </div>
                            @if (!string.IsNullOrEmpty(task.Description))
                            {
                                <p class="text-sm text-gray-600 mb-2 break-words whitespace-normal" style="word-wrap: break-word; max-width: 100%; overflow-wrap: break-word;">@task.Description</p>
                            }
                            <div class="flex flex-col space-y-2">
                                <div class="flex items-center justify-between">
                                    <span class="text-xs @(task.Priority == TaskPriority.Low ? "bg-blue-100 text-blue-800" : 
                                                     task.Priority == TaskPriority.Medium ? "bg-amber-100 text-amber-800" : 
                                                     task.Priority == TaskPriority.High ? "bg-orange-100 text-orange-800" : 
                                                     "bg-red-100 text-red-800") px-2 py-0.5 rounded-full">
                                        @(task.Priority == TaskPriority.Low ? "Düşük" : 
                                          task.Priority == TaskPriority.Medium ? "Orta" : 
                                          task.Priority == TaskPriority.High ? "Yüksek" : 
                                          "Acil")
                                    </span>
                                    @if (task.DueDate.HasValue)
                                    {
                                        <span class="text-xs text-gray-500">
                                            <i class="far fa-calendar-alt mr-1"></i>
                                            @task.DueDate.Value.ToString("dd MMM yyyy")
                                        </span>
                                    }
                                </div>
                                @if (task.AssignedMemberId != null)
                                {
                                    <div class="flex items-center mt-1">
                                        <span class="text-xs text-gray-600 flex items-center">
                                            @{
                                                var assignedMember = Model.TeamMembers.FirstOrDefault(m => m.UserId == task.AssignedMemberId);
                                            }
                                            @if (assignedMember != null)
                                            {
                                                <img src="@assignedMember.UserProfileImage" alt="@assignedMember.UserFullName" class="w-5 h-5 rounded-full mr-1 border border-gray-200" onerror="this.src='/images/profiles/default.png';">
                                                <span>@assignedMember.UserFullName</span>
                                            }
                                            else
                                            {
                                                <i class="fas fa-user mr-1"></i>
                                                <span>Atanmamış</span>
                                            }
                                        </span>
                                    </div>
                                }
                                @if (canModifyTasks)
                                {
                                    <div class="flex items-center justify-end space-x-1">
                                    <button class="move-task-btn bg-amber-100 text-amber-800 hover:bg-amber-200 text-xs px-2 py-1 rounded" data-task-id="@task.Id" data-status="1">
                                        <i class="fas fa-arrow-right"></i> Devam Ediyor
                                    </button>
                                </div>
                                }
                            </div>
                        </div>
                    }
                </div>
                
                @if (canModifyTasks)
                {
                    <div class="add-task-card bg-white rounded-lg border-2 border-dashed border-gray-200 p-3 hover:border-blue-300 transition-colors duration-200 cursor-pointer mt-3">
                        <button type="button" class="w-full text-left text-gray-500 hover:text-gray-700" data-project-id="@Model.Project.Id" data-status="0">
                            <i class="fas fa-plus mr-2"></i> Yeni Görev Ekle
                        </button>
                        </div>
                }
            </div>
            
            <!-- In Progress Tasks -->
            <div class="bg-white rounded-lg shadow p-4 flex flex-col">
                <div class="flex justify-between items-center mb-4">
                    <div class="flex items-center">
                        <h3 class="text-lg font-semibold text-gray-800">Devam Edenler</h3>
                        @if (canModifyTasks)
                        {
                            <button class="quick-add-task-btn ml-2 text-green-500 hover:text-green-700 transition-colors" data-status="1" data-project-id="@Model.Project.Id">
                                <i class="fas fa-plus-circle text-lg"></i>
                            </button>
                        }
                </div>
                    <span class="bg-amber-100 text-amber-800 text-xs font-medium px-2.5 py-0.5 rounded-full in-progress-count-badge" id="in-progress-count">@Model.InProgressTasks.Count</span>
                </div>
                <div id="in-progress-tasks" class="task-container space-y-3 min-h-[200px] p-2 rounded-lg border-2 border-dashed border-amber-100 border-opacity-0 transition-all hover:border-opacity-100 overflow-y-auto flex-grow">
                    @foreach (var task in Model.InProgressTasks)
                    {
                        <div class="task-card bg-white rounded-lg border border-gray-200 p-3 shadow-sm hover:shadow-md transition-shadow duration-200 cursor-grab active:cursor-grabbing" data-task-id="@task.Id">
                            <div class="flex justify-between items-start">
                                <h4 class="font-medium text-gray-800 mb-1">@task.Name</h4>
                                @if (canModifyTasks)
                                {
                                <div class="task-actions ml-2 flex items-center">
                                    <button class="edit-task-btn text-blue-500 hover:text-blue-700 mr-2" data-task-id="@task.Id">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button class="delete-task-btn text-red-500 hover:text-red-700" data-task-id="@task.Id">
                                        <i class="fas fa-trash-alt"></i>
                                    </button>
                                </div>
                                }
                            </div>
                            @if (!string.IsNullOrEmpty(task.Description))
                            {
                                <p class="text-sm text-gray-600 mb-2 break-words whitespace-normal" style="word-wrap: break-word; max-width: 100%; overflow-wrap: break-word;">@task.Description</p>
                            }
                            <div class="flex flex-col space-y-2">
                                <div class="flex items-center justify-between">
                                    <span class="text-xs @(task.Priority == TaskPriority.Low ? "bg-blue-100 text-blue-800" : 
                                                     task.Priority == TaskPriority.Medium ? "bg-amber-100 text-amber-800" : 
                                                     task.Priority == TaskPriority.High ? "bg-orange-100 text-orange-800" : 
                                                     "bg-red-100 text-red-800") px-2 py-0.5 rounded-full">
                                        @(task.Priority == TaskPriority.Low ? "Düşük" : 
                                          task.Priority == TaskPriority.Medium ? "Orta" : 
                                          task.Priority == TaskPriority.High ? "Yüksek" : 
                                          "Acil")
                                    </span>
                                    @if (task.DueDate.HasValue)
                                    {
                                        <span class="text-xs text-gray-500">
                                            <i class="far fa-calendar-alt mr-1"></i>
                                            @task.DueDate.Value.ToString("dd MMM yyyy")
                                        </span>
                                    }
                                </div>
                                @if (task.AssignedMemberId != null)
                                {
                                    <div class="flex items-center mt-1">
                                        <span class="text-xs text-gray-600 flex items-center">
                                            @{
                                                var assignedMember = Model.TeamMembers.FirstOrDefault(m => m.UserId == task.AssignedMemberId);
                                            }
                                            @if (assignedMember != null)
                                            {
                                                <img src="@assignedMember.UserProfileImage" alt="@assignedMember.UserFullName" class="w-5 h-5 rounded-full mr-1 border border-gray-200" onerror="this.src='/images/profiles/default.png';">
                                                <span>@assignedMember.UserFullName</span>
                                            }
                                            else
                                            {
                                                <i class="fas fa-user mr-1"></i>
                                                <span>Atanmamış</span>
                                            }
                                        </span>
                                    </div>
                                }
                                @if (canModifyTasks)
                                {
                                    <div class="flex justify-between items-center mt-2">
                                    <button class="move-task-btn bg-blue-100 text-blue-800 hover:bg-blue-200 text-xs px-2 py-1 rounded" data-task-id="@task.Id" data-status="0">
                                        <i class="fas fa-arrow-left"></i> Yapılacak
                                    </button>
                                    <button class="move-task-btn bg-green-100 text-green-800 hover:bg-green-200 text-xs px-2 py-1 rounded" data-task-id="@task.Id" data-status="2">
                                        <i class="fas fa-arrow-right"></i> Tamamlandı
                                    </button>
                                </div>
                                }
                            </div>
                        </div>
                    }
                </div>
                
                @if (canModifyTasks)
                {
                    <div class="add-task-card bg-white rounded-lg border-2 border-dashed border-gray-200 p-3 hover:border-amber-300 transition-colors duration-200 cursor-pointer mt-3">
                        <button type="button" class="w-full text-left text-gray-500 hover:text-gray-700" data-project-id="@Model.Project.Id" data-status="1">
                            <i class="fas fa-plus mr-2"></i> Yeni Görev Ekle
                        </button>
                        </div>
                }
            </div>
            
            <!-- Done Tasks -->
            <div class="bg-white rounded-lg shadow p-4 flex flex-col">
                <div class="flex justify-between items-center mb-4">
                    <div class="flex items-center">
                        <h3 class="text-lg font-semibold text-gray-800">Tamamlananlar</h3>
                        @if (canModifyTasks)
                        {
                            <button class="quick-add-task-btn ml-2 text-green-500 hover:text-green-700 transition-colors" data-status="2" data-project-id="@Model.Project.Id">
                                <i class="fas fa-plus-circle text-lg"></i>
                            </button>
                        }
                </div>
                    <span class="bg-green-100 text-green-800 text-xs font-medium px-2.5 py-0.5 rounded-full done-count-badge" id="done-count">@Model.DoneTasks.Count</span>
                </div>
                <div id="done-tasks" class="task-container space-y-3 min-h-[200px] p-2 rounded-lg border-2 border-dashed border-green-100 border-opacity-0 transition-all hover:border-opacity-100 overflow-y-auto flex-grow">
                    @foreach (var task in Model.DoneTasks)
                    {
                        <div class="task-card bg-white rounded-lg border border-gray-200 p-3 shadow-sm hover:shadow-md transition-shadow duration-200 cursor-grab active:cursor-grabbing" data-task-id="@task.Id">
                            <div class="flex justify-between items-start">
                                <h4 class="font-medium text-gray-800 mb-1">@task.Name</h4>
                                @if (canModifyTasks)
                                {
                                <div class="task-actions ml-2 flex items-center">
                                    <button class="edit-task-btn text-blue-500 hover:text-blue-700 mr-2" data-task-id="@task.Id">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button class="delete-task-btn text-red-500 hover:text-red-700" data-task-id="@task.Id">
                                        <i class="fas fa-trash-alt"></i>
                                    </button>
                                </div>
                                }
                            </div>
                            @if (!string.IsNullOrEmpty(task.Description))
                            {
                                <p class="text-sm text-gray-600 mb-2 break-words whitespace-normal" style="word-wrap: break-word; max-width: 100%; overflow-wrap: break-word;">@task.Description</p>
                            }
                            <div class="flex flex-col space-y-2">
                                <div class="flex items-center justify-between">
                                    <span class="text-xs @(task.Priority == TaskPriority.Low ? "bg-blue-100 text-blue-800" : 
                                                     task.Priority == TaskPriority.Medium ? "bg-amber-100 text-amber-800" : 
                                                     task.Priority == TaskPriority.High ? "bg-orange-100 text-orange-800" : 
                                                     "bg-red-100 text-red-800") px-2 py-0.5 rounded-full">
                                        @(task.Priority == TaskPriority.Low ? "Düşük" : 
                                          task.Priority == TaskPriority.Medium ? "Orta" : 
                                          task.Priority == TaskPriority.High ? "Yüksek" : 
                                          "Acil")
                                    </span>
                                    @if (task.DueDate.HasValue)
                                    {
                                        <span class="text-xs text-gray-500">
                                            <i class="far fa-calendar-alt mr-1"></i>
                                            @task.DueDate.Value.ToString("dd MMM yyyy")
                                        </span>
                                    }
                                </div>
                                @if (task.AssignedMemberId != null)
                                {
                                    <div class="flex items-center mt-1">
                                        <span class="text-xs text-gray-600 flex items-center">
                                            @{
                                                var assignedMember = Model.TeamMembers.FirstOrDefault(m => m.UserId == task.AssignedMemberId);
                                            }
                                            @if (assignedMember != null)
                                            {
                                                <img src="@assignedMember.UserProfileImage" alt="@assignedMember.UserFullName" class="w-5 h-5 rounded-full mr-1 border border-gray-200" onerror="this.src='/images/profiles/default.png';">
                                                <span>@assignedMember.UserFullName</span>
                                            }
                                            else
                                            {
                                                <i class="fas fa-user mr-1"></i>
                                                <span>Atanmamış</span>
                                            }
                                        </span>
                                    </div>
                                }
                                @if (canModifyTasks)
                                {
                                    <div class="flex justify-end items-center mt-2">
                                    <button class="move-task-btn bg-amber-100 text-amber-800 hover:bg-amber-200 text-xs px-2 py-1 rounded" data-task-id="@task.Id" data-status="1">
                                        <i class="fas fa-arrow-left"></i> Devam Ediyor
                                    </button>
                                </div>
                                }
                            </div>
                        </div>
                    }
                </div>
                
                @if (canModifyTasks)
                {
                    <div class="add-task-card bg-white rounded-lg border-2 border-dashed border-gray-200 p-3 hover:border-green-300 transition-colors duration-200 cursor-pointer mt-3">
                        <button type="button" class="w-full text-left text-gray-500 hover:text-gray-700" data-project-id="@Model.Project.Id" data-status="2">
                            <i class="fas fa-plus mr-2"></i> Yeni Görev Ekle
                        </button>
                        </div>
                }
            </div>
        </div>
    </div>
</div>

<!-- Görev Ekleme Modalı -->
<div id="add-task-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
    <div class="relative top-20 mx-auto p-6 border w-[500px] shadow-lg rounded-lg bg-white">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-xl font-semibold text-gray-900">Yeni Görev Ekle</h3>
            <button type="button" id="close-task-modal" class="text-gray-400 hover:text-gray-500">
                <i class="fas fa-times"></i>
            </button>
        </div>
        
        <form asp-action="CreateTask" asp-controller="Project" method="post" class="space-y-4" id="create-task-form">
            @Html.AntiForgeryToken()
            <input type="hidden" id="task-project-id" name="ProjectId" />
            <input type="hidden" id="task-status" name="Status" />
            
                <div>
                <label for="task-name" class="block text-sm font-medium text-gray-700 mb-1">Görev Adı</label>
                <input type="text" id="task-name" name="Name" required
                       class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-primary-500 focus:border-primary-500 text-gray-900"
                       placeholder="Görev adını girin">
                    </div>
                
                <div>
                <label for="task-description" class="block text-sm font-medium text-gray-700 mb-1">Açıklama</label>
                <textarea id="task-description" name="Description" rows="3"
                        class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-primary-500 focus:border-primary-500 text-gray-900"
                        placeholder="Görev açıklamasını girin"></textarea>
                    </div>
                
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label for="task-priority" class="block text-sm font-medium text-gray-700 mb-1">Öncelik</label>
                    <select id="task-priority" name="Priority"
                            class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-primary-500 focus:border-primary-500 text-gray-900">
                        <option value="0">Düşük</option>
                        <option value="1">Orta</option>
                        <option value="2">Yüksek</option>
                        <option value="3">Acil</option>
                    </select>
                </div>
                
                <div>
                    <label for="task-due-date" class="block text-sm font-medium text-gray-700 mb-1">Bitiş Tarihi</label>
                    <input type="date" id="task-due-date" name="DueDate"
                           class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-primary-500 focus:border-primary-500 text-gray-900">
                </div>
            </div>
            
            <div>
                <label for="task-assigned-member" class="block text-sm font-medium text-gray-700 mb-1">Atanan Üye</label>
                <select id="task-assigned-member" name="AssignedMemberId"
                        class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-primary-500 focus:border-primary-500 text-gray-900">
                    <option value="">Seçiniz...</option>
                    @foreach (var member in Model.TeamMembers)
                    {
                        <option value="@member.UserId">@member.UserFullName</option>
                    }
                </select>
            </div>
            
            <div class="flex justify-end space-x-3 pt-4">
                <button type="button" id="cancel-task" class="px-4 py-2 border border-gray-300 rounded-md text-gray-700 bg-white hover:bg-gray-50 transition-colors focus:outline-none focus:ring-2 focus:ring-gray-300 focus:ring-offset-1">
                    İptal
                </button>
                <button type="submit" class="px-4 py-2 bg-primary-500 hover:bg-primary-600 text-white rounded-md transition-colors focus:outline-none focus:ring-2 focus:ring-primary-500 focus:ring-offset-1">
                    Kaydet
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Görev Silme Modalı -->
<div id="delete-task-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden">
    <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
        <div class="mt-3">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-medium leading-6 text-gray-900">Görevi Sil</h3>
                <button id="close-delete-task-modal" class="text-gray-400 hover:text-gray-500 focus:outline-none">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <p class="text-sm text-gray-500 mb-4">Bu görevi silmek istediğinize emin misiniz?</p>
            <input type="hidden" id="delete-task-id" name="taskId" />
            <div class="flex justify-end space-x-3">
                <button type="button" id="cancel-delete-task"
                        class="px-4 py-2 bg-gray-100 text-gray-700 rounded-md hover:bg-gray-200">
                    İptal
                </button>
                <button type="button" id="confirm-delete-task"
                        class="px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700">
                    Sil
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Görev Düzenleme Modal -->
<div id="edit-task-modal" class="fixed inset-0 flex items-center justify-center z-50 hidden">
    <div class="absolute inset-0 bg-black opacity-50"></div>
    <div class="bg-white rounded-lg p-6 max-w-md w-full mx-4 relative z-10 shadow-xl">
        <h3 class="text-xl font-medium text-gray-900 mb-4">Görev Düzenle</h3>
        
        <div class="absolute top-4 right-4">
            <button id="close-edit-task-modal" class="text-gray-400 hover:text-gray-500">
                <i class="fas fa-times"></i>
            </button>
        </div>
        
        <form id="edit-task-form" class="space-y-4">
            @Html.AntiForgeryToken()
            <input type="hidden" id="edit-task-id" name="Id" />
            <input type="hidden" id="edit-task-project-id" name="ProjectId" value="@Model.Project.Id" />
            <input type="hidden" id="edit-task-status" name="Status" />
            
            <div>
                <label for="edit-task-name" class="block text-sm font-medium text-gray-700 mb-1">Görev Adı</label>
                <input type="text" id="edit-task-name" name="Name" required
                       class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-primary-500 focus:border-primary-500 text-gray-900"
                       placeholder="Görev adını girin">
            </div>
            
            <div>
                <label for="edit-task-description" class="block text-sm font-medium text-gray-700 mb-1">Açıklama</label>
                <textarea id="edit-task-description" name="Description" rows="3"
                          class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-primary-500 focus:border-primary-500 text-gray-900"
                          placeholder="Görev açıklamasını girin"></textarea>
            </div>
            
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label for="edit-task-priority" class="block text-sm font-medium text-gray-700 mb-1">Öncelik</label>
                    <select id="edit-task-priority" name="Priority"
                            class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-primary-500 focus:border-primary-500 text-gray-900">
                        <option value="0">Düşük</option>
                        <option value="1">Orta</option>
                        <option value="2">Yüksek</option>
                        <option value="3">Acil</option>
                    </select>
                </div>
                
                <div>
                    <label for="edit-task-due-date" class="block text-sm font-medium text-gray-700 mb-1">Bitiş Tarihi</label>
                    <input type="date" id="edit-task-due-date" name="DueDate"
                           class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-primary-500 focus:border-primary-500 text-gray-900">
                </div>
            </div>
            
            <div>
                <label for="edit-task-assigned-member" class="block text-sm font-medium text-gray-700 mb-1">Atanan Üye</label>
                <select id="edit-task-assigned-member" name="AssignedMemberId"
                        class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-primary-500 focus:border-primary-500 text-gray-900">
                    <option value="">Atanmamış</option>
                    @foreach (var member in Model.TeamMembers)
                    {
                        <option value="@member.MemberId" data-user-id="@member.UserId">@member.UserFullName</option>
                    }
                </select>
            </div>
            
            <div class="flex justify-end mt-4 gap-2">
                <button type="button" id="cancel-edit-task" class="px-4 py-2 bg-gray-300 text-gray-700 rounded hover:bg-gray-400">İptal</button>
                <button type="button" id="edit-task-save-btn" class="px-4 py-2 bg-indigo-600 text-white rounded hover:bg-indigo-700">Kaydet</button>
            </div>
        </form>
    </div>
</div>

<!-- Proje Silme Modal -->
<div id="delete-project-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
    <div class="bg-white rounded-lg shadow-lg p-6 w-full max-w-md transform transition-all scale-95 opacity-0" id="delete-modal-content">
        <div class="flex items-center justify-between mb-4">
            <h3 class="text-xl font-semibold text-red-600">Projeyi Sil</h3>
            <button id="close-delete-modal" class="text-gray-400 hover:text-gray-500 focus:outline-none">
                <i class="fas fa-times"></i>
            </button>
        </div>
        
        <div class="mb-6">
            <p class="text-gray-700 mb-4">Bu işlem projeyi ve tüm görevlerini <span class="font-bold">kalıcı olarak</span> silecektir. Bu işlem geri alınamaz.</p>
            
            <div class="bg-red-50 border-l-4 border-red-500 p-4 mb-4">
                <div class="flex">
                    <div class="flex-shrink-0">
                        <i class="fas fa-exclamation-triangle text-red-500"></i>
                    </div>
                    <div class="ml-3">
                        <p class="text-sm text-red-700">Projeyi silmek istediğinizden emin misiniz?</p>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="flex justify-end space-x-3">
            <button type="button" id="cancel-delete" class="px-4 py-2 border border-gray-300 rounded-md text-gray-700 bg-white hover:bg-gray-50 transition-colors focus:outline-none focus:ring-2 focus:ring-gray-300 focus:ring-offset-1">
                İptal
            </button>
            <button type="button" id="confirm-delete" class="px-4 py-2 bg-red-500 hover:bg-red-600 text-white rounded-md transition-colors focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-1">
                Projeyi Sil
            </button>
        </div>
    </div>
</div>

<!-- Projeden Ayrılma Modal -->
<div id="leave-project-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
    <div class="bg-white rounded-lg shadow-lg p-6 w-full max-w-md transform transition-all scale-95 opacity-0" id="leave-modal-content">
        <div class="flex items-center justify-between mb-4">
            <h3 class="text-xl font-semibold text-yellow-600">Projeden Ayrıl</h3>
            <button id="close-leave-modal" class="text-gray-400 hover:text-gray-500 focus:outline-none">
                <i class="fas fa-times"></i>
            </button>
        </div>
        
        <div class="mb-6">
            <p class="text-gray-700 mb-4">Bu projeden ayrılmak istediğinize emin misiniz?</p>
            
            <div class="bg-yellow-50 border-l-4 border-yellow-500 p-4 mb-4">
                <div class="flex">
                    <div class="flex-shrink-0">
                        <i class="fas fa-exclamation-triangle text-yellow-500"></i>
                    </div>
                    <div class="ml-3">
                        <p class="text-sm text-yellow-700">Projeden ayrıldıktan sonra tüm proje erişiminizi kaybedeceksiniz. Bu işlem geri alınamaz.</p>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="flex justify-end space-x-3">
            <button type="button" id="cancel-leave" class="px-4 py-2 border border-gray-300 rounded-md text-gray-700 bg-white hover:bg-gray-50 transition-colors focus:outline-none focus:ring-2 focus:ring-gray-300 focus:ring-offset-1">
                İptal
            </button>
            <button type="button" id="confirm-leave" class="px-4 py-2 bg-yellow-500 hover:bg-yellow-600 text-white rounded-md transition-colors focus:outline-none focus:ring-2 focus:ring-yellow-500 focus:ring-offset-1">
                Projeden Ayrıl
            </button>
        </div>
    </div>
</div>

@section Scripts {
    <!-- SortableJS kütüphanesi -->
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    
    <!-- SignalR kütüphanesini güvenli bir şekilde ekle -->
    <script src="https://cdn.jsdelivr.net/npm/@@microsoft/signalr@7.0.0/dist/browser/signalr.min.js"></script>
    
    <script>
        // DOM yüklendikten sonra çalıştır
        $(document).ready(function() {
            console.log("DOM ready - Task permissions: canModifyTasks=@canModifyTasks");
        
            // Mesajları otomatik gizleme
            setTimeout(function() {
                $(".alert").fadeOut(500);
            }, 5000);
            
            // Görev ekleme butonları için event listener'lar - Debug için console.log ekledik
            $(".add-task-card button").on("click", function() {
                console.log("Add task card button clicked");
                const projectId = $(this).data("project-id");
                const status = $(this).data("status");
                console.log("Project ID:", projectId, "Status:", status);
                showAddTaskModal(projectId, status);
            });
            
            // Hızlı görev ekleme butonları için event listener - Debug için console.log ekledik
            $(".quick-add-task-btn").on("click", function() {
                console.log("Quick add task button clicked");
                const projectId = $(this).data("project-id");
                const status = $(this).data("status");
                console.log("Project ID:", projectId, "Status:", status);
                showAddTaskModal(projectId, status);
            });
            
            // Yeni görev ekleme modalını göster
            function showAddTaskModal(projectId, status) {
                console.log("Showing add task modal for project:", projectId, "status:", status);
                // Modal değerlerini ayarla
                $("#task-project-id").val(projectId);
                $("#task-status").val(status);
                
                // Modalı göster
                $("#add-task-modal").removeClass("hidden");
                $("body").css("overflow", "hidden"); // Arka planı kaydırmayı engelle
            }
            
            // Görev ekleme modalı kapatma
            $("#close-task-modal, #cancel-task").on("click", function() {
                $("#add-task-modal").addClass("hidden");
                $("body").css("overflow", ""); // Kaydırmayı tekrar etkinleştir
                $("#create-task-form")[0].reset();
            });
            
            // Görev silme
            $(document).on("click", ".delete-task-btn", function() {
                console.log("Delete task button clicked");
                const taskId = $(this).data("task-id");
                console.log("Task ID:", taskId);
                $("#delete-task-id").val(taskId);
                $("#delete-task-modal").removeClass("hidden");
                $("body").css("overflow", "hidden");
            });
            
            // Görev silme modalı kapatma
            $("#close-delete-task-modal, #cancel-delete-task").on("click", function() {
                $("#delete-task-modal").addClass("hidden");
                $("body").css("overflow", "");
            });
            
            // Görev silme işlemi
            $("#confirm-delete-task").on("click", function() {
                const taskId = $("#delete-task-id").val();
                console.log("Confirming delete for task ID:", taskId);
                
                $.ajax({
                    url: "@Url.Action("DeleteTask", "Project")",
                    type: "POST",
                    data: {
                        taskId: taskId
                    },
                    success: function(response) {
                        if (response.success) {
                            // Modal kapat
                            $("#delete-task-modal").addClass("hidden");
                            $("body").css("overflow", "auto");
                            
                            // Görevi DOM'dan kaldır
                            $(`.task-card[data-task-id="${taskId}"]`).fadeOut(300, function() {
                                $(this).remove();
                                
                                // Sayaçları güncelle
                                updateTaskCounters();
                                // Tamamlanma yüzdesini güncelle
                                updateCompletionPercentage();
                                
                                // Başarı mesajı göster
                                showNotification("Görev başarıyla silindi", "success");
                            });
                        } else {
                            // Hata mesajı göster
                            $("#delete-task-modal").addClass("hidden");
                            $("body").css("overflow", "auto");
                            showNotification("Hata: " + response.message, "error");
                        }
                    },
                    error: function(xhr, status, error) {
                        $("#delete-task-modal").addClass("hidden");
                        $("body").css("overflow", "auto");
                        showNotification("Bağlantı hatası oluştu. Lütfen tekrar deneyin.", "error");
                    }
                });
            });
            
            // Görev düzenleme
            $(document).on("click", ".edit-task-btn", function() {
                console.log("Edit task button clicked");
                const taskId = $(this).data("task-id");
                console.log("Task ID:", taskId);
                
                // Görevi Ajax ile getir
                $.ajax({
                    url: "@Url.Action("GetTask", "Project")",
                    type: "GET",
                    data: { taskId: taskId },
                    success: function(task) {
                        if (task) {
                            console.log("Görev verisi alındı:", task);
                            
                            // Modal alanlarını doldur
                            $("#edit-task-id").val(task.id);
                            $("#edit-task-project-id").val(task.projectId);
                            $("#edit-task-status").val(task.status);
                            $("#edit-task-name").val(task.name);
                            $("#edit-task-description").val(task.description);
                            $("#edit-task-priority").val(task.priority);
                            
                            // Bitiş tarihi varsa formatla ve ata
                            if (task.dueDate) {
                                const dueDate = new Date(task.dueDate);
                                $("#edit-task-due-date").val(dueDate.toISOString().split('T')[0]);
                            } else {
                                $("#edit-task-due-date").val('');
                            }
                            
                            // Atanan üye seçimini güncelle
                            console.log("Atanan üye ID:", task.assignedMemberId);
                            
                            // Mevcut tüm takım üyelerini getir
                            const teamMembers = @Html.Raw(Json.Serialize(Model.TeamMembers));
                            console.log("Takım üyeleri:", teamMembers);
                            
                            // Select elementi ve tüm seçenekleri kontrol et
                            const selectElement = document.getElementById("edit-task-assigned-member");
                            console.log("Select element:", selectElement);
                            Array.from(selectElement.options).forEach(option => {
                                console.log(`Option: value=${option.value}, data-user-id=${option.getAttribute('data-user-id')}`);
                            });
                            
                            // Atanan üye ID'sini düzgün şekilde handle et
                            if (task.assignedMemberId && task.assignedMemberId !== "") {
                                console.log("Atanacak üye ID değeri:", task.assignedMemberId, "Tip:", typeof task.assignedMemberId);
                                
                                // Tüm seçenekleri kontrol et ve veri özniteliği eşleşeni bul
                                let optionFound = false;
                                
                                // Öncelikle tüm seçenek değerlerini string olarak karşılaştır
                                const assignedIdStr = String(task.assignedMemberId);
                                
                                // Forma üye ID değerini doğrudan atamayı dene
                                $("#edit-task-assigned-member").val(assignedIdStr);
                                
                                // Atama başarılı mı kontrol et
                                if ($("#edit-task-assigned-member").val() === assignedIdStr) {
                                    console.log(`Doğrudan atama başarılı: ${assignedIdStr}`);
                                    optionFound = true;
                                } else {
                                    console.log("Doğrudan atama başarısız, alternatif yöntemler deneniyor");
                                    
                                    // Her option için kontrol
                                    Array.from(selectElement.options).forEach(option => {
                                        const optionVal = String(option.value);
                                        const optionUserId = String(option.getAttribute('data-user-id') || "");
                                        
                                        console.log(`Karşılaştırma: 
                                            option.value (${typeof optionVal}) = ${optionVal} 
                                            vs 
                                            assignedIdStr (${typeof assignedIdStr}) = ${assignedIdStr}`);
                                            
                                        console.log(`Kullanıcı ID Karşılaştırma: 
                                            option.data-user-id (${typeof optionUserId}) = ${optionUserId} 
                                            vs 
                                            assignedIdStr (${typeof assignedIdStr}) = ${assignedIdStr}`);
                                        
                                        // Değer veya kullanıcı ID eşleşmesi
                                        if (optionVal === assignedIdStr || optionUserId === assignedIdStr) {
                                            option.selected = true;
                                            $("#edit-task-assigned-member").val(optionVal);
                                        optionFound = true;
                                            console.log(`Eşleşen seçenek bulundu: ${optionVal}`);
                                    }
                                    });
                                }
                                
                                if (!optionFound) {
                                    console.log("Eşleşen seçenek bulunamadı, boş değer atanıyor");
                                    $("#edit-task-assigned-member").val("");
                                        }
                                    } else {
                                // Atanmış üye yoksa boş seç
                                console.log("Atanmış üye bilgisi yok, boş değer atanıyor");
                                $("#edit-task-assigned-member").val("");
                            }
                            
                            // Modalı göster
                            $("#edit-task-modal").removeClass("hidden");
                            $("body").css("overflow", "hidden");
                        } else {
                            showNotification("Görev bilgileri alınamadı", "error");
                        }
                    },
                    error: function() {
                        showNotification("Bağlantı hatası oluştu", "error");
                    }
                });
            });
            
            // Görev taşıma butonları için event listener
            $(document).on("click", ".move-task-btn", function() {
                console.log("Move task button clicked");
                const taskId = $(this).data("task-id");
                const newStatus = parseInt($(this).data("status"));
                console.log("Task ID:", taskId, "New Status:", newStatus);
                
                // AJAX ile görev durumunu güncelle
                $.ajax({
                    url: "@Url.Action("UpdateTaskStatus", "Project")",
                    type: "POST",
                    data: {
                        taskId: taskId,
                        newStatus: newStatus
                    },
                    success: function(response) {
                        if (response.success) {
                            // Başarılı olduğunda görev kartını taşı
                            const taskCard = $(`.task-card[data-task-id="${taskId}"]`);
                            
                            // Görev kartını yeni konuma taşı
                            if (newStatus === 0) { // Todo
                                $("#todo-tasks").append(taskCard);
                            } else if (newStatus === 1) { // In Progress
                                $("#in-progress-tasks").append(taskCard);
                            } else if (newStatus === 2) { // Done
                                $("#done-tasks").append(taskCard);
                            }
                            
                            // Görev butonlarını güncelle
                            updateTaskButtons(taskCard, newStatus);
                            
                            // Sayaçları ve tamamlanma yüzdesini güncelle
                            updateTaskCounters();
                            updateCompletionPercentage();
                            
                            // Başarı mesajı göster
                            showNotification("Görev durumu güncellendi", "success");
                        } else {
                            // Hata mesajı göster
                            showNotification("Hata: " + response.message, "error");
                        }
                    },
                    error: function() {
                        showNotification("Bağlantı hatası oluştu", "error");
                    }
                });
            });
            
            // Görev formunu submit
            $("#create-task-form").on("submit", function(e) {
                e.preventDefault(); // Prevent the default form submission
                
                const taskName = $("#task-name").val();
                
                if (!taskName || taskName.trim() === "") {
                    showNotification("Görev adı zorunludur", "error");
                    return false;
                }
                
                // Get form data
                const formData = $(this).serialize();
                
                // Send AJAX request
                $.ajax({
                    url: "@Url.Action("CreateTask", "Project")",
                    type: "POST",
                    data: formData,
                    headers: {
                        "X-Requested-With": "XMLHttpRequest"
                    },
                    success: function(response) {
                        if (response && response.success) {
                            // Reset the form
                            $("#create-task-form")[0].reset();
                            
                            // Close the modal
                            $("#add-task-modal").addClass("hidden");
                            $("body").css("overflow", "");
                            
                            // Show success notification
                            showNotification("Görev başarıyla oluşturuldu", "success");
                            
                            // SignalR bağlantısı yoksa veya gecikmeli çalışıyorsa, görev kartını manuel olarak oluştur
                            if (response.task) {
                                // Görevi ilgili sütuna ekleyelim
                                const task = response.task;
                                const assignedMember = response.assignedMember;
                                
                                // Önce bu ID'de bir görev kartı var mı kontrol et (SignalR zaten eklemiş olabilir)
                                const existingTaskCard = $(`.task-card[data-task-id="${task.id}"]`);
                                if (existingTaskCard.length === 0) {
                                    // createTaskCard fonksiyonu ile HTML oluştur
                                    const taskHtml = createTaskCard(task, assignedMember);
                                    
                                    // Durumuna göre uygun listeye ekle
                                    if (task.status === 0) {
                                        // Todo listesine ekle
                                        $("#todo-tasks").append(taskHtml);
                                    } else if (task.status === 1) {
                                        // In Progress listesine ekle
                                        $("#in-progress-tasks").append(taskHtml);
                                    } else if (task.status === 2) {
                                        // Done listesine ekle
                                        $("#done-tasks").append(taskHtml);
                                    }
                                    
                                    // Yeni eklenen kartın butonlarını durumuna göre güncelleyelim
                                    const newTaskCard = $(`.task-card[data-task-id="${task.id}"]`);
                                    if (newTaskCard.length > 0) {
                                        updateTaskButtons(newTaskCard, task.status);
                                    }
                                    
                                    // Sayaçları ve tamamlanma yüzdesini güncelle
                                    updateTaskCounters();
                                    updateCompletionPercentage();
                                }
                            }
                        } else {
                            showNotification(response.message || "Görev oluşturulurken bir hata oluştu", "error");
                        }
                    },
                    error: function(xhr, status, error) {
                        console.error("Görev oluşturma hatası:", error);
                        showNotification("Görev oluşturulurken bir hata oluştu: " + error, "error");
                    }
                });
                
                return false;
            });
            
            // Görev butonlarını güncelleyen fonksiyon
            function updateTaskButtons(taskCard, newStatus) {
                // Task bilgilerini bul
                const taskId = taskCard.data('task-id');
                
                // Mevcut tüm taşıma butonlarını bulup temizle
                taskCard.find('.flex.space-x-2.mt-2').remove();
                taskCard.find('.flex.justify-between.items-center.mt-2').remove();
                taskCard.find('.flex.justify-end.items-center.mt-2').remove();
                taskCard.find('.flex.items-center.justify-end.space-x-1.mt-2').remove();
                taskCard.find('.flex.items-center.justify-end.space-x-1').remove();
                
                // canModifyTasks değerini kontrol et (Razor kullanarak)
                @if (canModifyTasks) {
                    <text>
                    // Yeni butonları ekleyelim - createTaskCard ile tutarlı olacak şekilde
                    if (newStatus === 0) { // Todo - Todo sütunundayken
                        taskCard.append(`
                            <div class="flex space-x-2 mt-2">
                                <button class="move-task-btn text-xs px-2 py-1 bg-amber-100 text-amber-800 rounded hover:bg-amber-200" data-task-id="${taskId}" data-status="1">
                                    <i class="fas fa-arrow-right"></i> İlerliyor
                                </button>
                                <button class="move-task-btn text-xs px-2 py-1 bg-green-100 text-green-800 rounded hover:bg-green-200" data-task-id="${taskId}" data-status="2">
                                    <i class="fas fa-arrow-right"></i> Tamamlandı
                                </button>
                            </div>
                        `);
                    } else if (newStatus === 1) { // In Progress - Devam edenler sütunundayken
                        taskCard.append(`
                            <div class="flex space-x-2 mt-2">
                                <button class="move-task-btn text-xs px-2 py-1 bg-blue-100 text-blue-800 rounded hover:bg-blue-200" data-task-id="${taskId}" data-status="0">
                                    <i class="fas fa-arrow-left"></i> Yapılacak
                                </button>
                                <button class="move-task-btn text-xs px-2 py-1 bg-green-100 text-green-800 rounded hover:bg-green-200" data-task-id="${taskId}" data-status="2">
                                    <i class="fas fa-arrow-right"></i> Tamamlandı
                                </button>
                            </div>
                        `);
                    } else if (newStatus === 2) { // Done - Tamamlandı sütunundayken
                        taskCard.append(`
                            <div class="flex space-x-2 mt-2">
                                <button class="move-task-btn text-xs px-2 py-1 bg-blue-100 text-blue-800 rounded hover:bg-blue-200" data-task-id="${taskId}" data-status="0">
                                    <i class="fas fa-arrow-left"></i> Yapılacak
                                </button>
                                <button class="move-task-btn text-xs px-2 py-1 bg-amber-100 text-amber-800 rounded hover:bg-amber-200" data-task-id="${taskId}" data-status="1">
                                    <i class="fas fa-arrow-left"></i> İlerliyor
                                </button>
                            </div>
                        `);
                    }
                    </text>
                }
            }
            
            // Görev taşıma butonları için event listener
            $(document).on("click", ".move-task-btn", function() {
                const taskId = $(this).data("task-id");
                const newStatus = parseInt($(this).data("status"));
                
                // AJAX ile görev durumunu güncelle
                $.ajax({
                    url: "@Url.Action("UpdateTaskStatus", "Project")",
                    type: "POST",
                    data: {
                        taskId: taskId,
                        newStatus: newStatus
                    },
                    success: function(response) {
                        if (response.success) {
                            // Başarılı olduğunda görevleri güncelle
                            const taskCard = $(`.task-card[data-task-id="${taskId}"]`);
                            updateTaskButtons(taskCard, newStatus);
                            updateTaskCounters();
                            updateCompletionPercentage();
                            
                            // Bildirim göster
                            showNotification("Görev durumu güncellendi", "success");
                        } else {
                            // Hata durumunda bildirim göster
                            showNotification("Hata: " + response.message, "error");
                        }
                    },
                    error: function() {
                        showNotification("Bağlantı hatası oluştu", "error");
                    }
                });
            });
            
            // Sürükle-bırak işlevini etkinleştir
            const todoList = document.getElementById('todo-tasks');
            const inProgressList = document.getElementById('in-progress-tasks');
            const doneList = document.getElementById('done-tasks');
            
            // Todo listesi için Sortable başlat
            new Sortable(todoList, {
                group: 'tasks', // Gruplar arası taşıma için
                animation: 150,
                ghostClass: 'bg-blue-50',
                dragClass: 'opacity-75',
                chosenClass: 'shadow-lg',
                sort: true,
                invertSwap: true,
                onStart: function() {
                    $('.task-container').addClass('border-opacity-100');
                },
                onEnd: function(evt) {
                    $('.task-container').removeClass('border-opacity-100');
                    
                    if (evt.from !== evt.to) {
                        const taskId = evt.item.getAttribute('data-task-id');
                        let newStatus = 0; // Varsayılan Todo
                        
                        if (evt.to.id === 'in-progress-tasks') {
                            newStatus = 1; // In Progress
                        } else if (evt.to.id === 'done-tasks') {
                            newStatus = 2; // Done
                        }
                        
                        // AJAX ile görev durumunu güncelle
                        $.ajax({
                            url: "@Url.Action("UpdateTaskStatus", "Project")",
                            type: "POST",
                            data: {
                                taskId: taskId,
                                newStatus: newStatus
                            },
                            success: function(response) {
                                if (response.success) {
                                    // Başarılı olduğunda görevleri güncelle
                                    const taskCard = $(`.task-card[data-task-id="${taskId}"]`);
                                    updateTaskButtons(taskCard, newStatus);
                                    updateTaskCounters();
                                    updateCompletionPercentage();
                                } else {
                                    // Hata durumunda sayfayı yenile
                                    showNotification("Hata: " + response.message, "error");
                                    window.location.reload();
                                }
                            },
                            error: function() {
                                showNotification("Bağlantı hatası oluştu", "error");
                                window.location.reload();
                            }
                        });
                    }
                }
            });
            
            // In Progress listesi için Sortable başlat
            new Sortable(inProgressList, {
                group: 'tasks',
                animation: 150,
                ghostClass: 'bg-amber-50',
                dragClass: 'opacity-75',
                chosenClass: 'shadow-lg',
                sort: true,
                invertSwap: true,
                onStart: function() {
                    $('.task-container').addClass('border-opacity-100');
                },
                onEnd: function(evt) {
                    $('.task-container').removeClass('border-opacity-100');
                    
                    if (evt.from !== evt.to) {
                        const taskId = evt.item.getAttribute('data-task-id');
                        let newStatus = 1; // Varsayılan In Progress
                        
                        if (evt.to.id === 'todo-tasks') {
                            newStatus = 0; // Todo
                        } else if (evt.to.id === 'done-tasks') {
                            newStatus = 2; // Done
                        }
                        
                        // AJAX ile görev durumunu güncelle
                        $.ajax({
                            url: "@Url.Action("UpdateTaskStatus", "Project")",
                            type: "POST",
                            data: {
                                taskId: taskId,
                                newStatus: newStatus
                            },
                            success: function(response) {
                                if (response.success) {
                                    // Başarılı olduğunda görevleri güncelle
                                    const taskCard = $(`.task-card[data-task-id="${taskId}"]`);
                                    updateTaskButtons(taskCard, newStatus);
                                    updateTaskCounters();
                                    updateCompletionPercentage();
                                } else {
                                    // Hata durumunda sayfayı yenile
                                    showNotification("Hata: " + response.message, "error");
                                    window.location.reload();
                                }
                            },
                            error: function() {
                                showNotification("Bağlantı hatası oluştu", "error");
                                window.location.reload();
                            }
                        });
                    }
                }
            });
            
            // Done listesi için Sortable başlat
            new Sortable(doneList, {
                group: 'tasks',
                animation: 150,
                ghostClass: 'bg-green-50',
                dragClass: 'opacity-75',
                chosenClass: 'shadow-lg',
                sort: true,
                invertSwap: true,
                onStart: function() {
                    $('.task-container').addClass('border-opacity-100');
                },
                onEnd: function(evt) {
                    $('.task-container').removeClass('border-opacity-100');
                    
                    if (evt.from !== evt.to) {
                        const taskId = evt.item.getAttribute('data-task-id');
                        let newStatus = 2; // Varsayılan Done
                        
                        if (evt.to.id === 'todo-tasks') {
                            newStatus = 0; // Todo
                        } else if (evt.to.id === 'in-progress-tasks') {
                            newStatus = 1; // In Progress
                        }
                        
                        // AJAX ile görev durumunu güncelle
                        $.ajax({
                            url: "@Url.Action("UpdateTaskStatus", "Project")",
                            type: "POST",
                            data: {
                                taskId: taskId,
                                newStatus: newStatus
                            },
                            success: function(response) {
                                if (response.success) {
                                    // Başarılı olduğunda görevleri güncelle
                                    const taskCard = $(`.task-card[data-task-id="${taskId}"]`);
                                    updateTaskButtons(taskCard, newStatus);
                                    updateTaskCounters();
                                    updateCompletionPercentage();
                                } else {
                                    // Hata durumunda sayfayı yenile
                                    showNotification("Hata: " + response.message, "error");
                                    window.location.reload();
                                }
                            },
                            error: function() {
                                showNotification("Bağlantı hatası oluştu", "error");
                                window.location.reload();
                            }
                        });
                    }
                }
            });
            
            // SignalR bağlantısı
            const connection = new signalR.HubConnectionBuilder()
                .withUrl("/taskHub")
                .withAutomaticReconnect()
                .build();
            
            // Son güncelleme süresini izlemek için yardımcı değişkenler
            const taskUpdateTimers = {};
            const UPDATE_COOLDOWN = 500; // ms cinsinden güncelleme bekleme süresi
            
            // Tekrarlı güncellemeleri önleyen yardımcı fonksiyon
            function preventDuplicateUpdates(taskId, callback) {
                // Eğer bu görev için bir zamanlayıcı zaten varsa, temizle
                if (taskUpdateTimers[taskId]) {
                    clearTimeout(taskUpdateTimers[taskId]);
                }
                
                // Yeni bir zamanlayıcı ayarla
                taskUpdateTimers[taskId] = setTimeout(() => {
                    // Zamanlayıcıyı temizle
                    delete taskUpdateTimers[taskId];
                    // Callback'i çağır
                    callback();
                }, UPDATE_COOLDOWN);
            }
            
            // Bağlantıyı başlatmayı dene
            try {
                if (connection.state === "Disconnected" || !connection.state) {
                connection.start().then(function() {
                    console.log("SignalR bağlantısı kuruldu");
                    // Bağlantı açıldığında sonrasında proje grubuna katıl
                    connection.invoke("JoinProjectGroup", @Model.Project.Id)
                        .then(function() {
                            console.log("Proje grubuna başarıyla katıldı: project_@Model.Project.Id");
                        })
                        .catch(function(err) {
                            console.error("Proje grubuna katılırken hata oluştu: " + err.toString());
                        });
                }).catch(function(err) {
                    console.error("SignalR bağlantısı kurulamadı: " + err.toString());
                });
                } else {
                    console.log("SignalR bağlantısı zaten kurulu durumda: " + connection.state);
                }
            } catch (error) {
                console.error("SignalR başlatılırken hata oluştu:", error);
            }
            
            // Yeni görev eklendiğinde
            connection.on("ReceiveNewTask", function(data) {
                console.log("SignalR: Yeni görev alındı:", data);
                
                // Veriyi ayır - Şimdi taskForSignalR objesi içinde
                const task = data.task;
                const assignedMember = data.assignedMember;
                
                // Görev zaten mevcut mu kontrol et (AJAX yanıtında eklenmişse)
                const existingTaskCard = $(`.task-card[data-task-id="${task.id}"]`);
                if (existingTaskCard.length === 0) {
                    // Görevin durumuna göre ilgili listeye ekle
                    // Atanan üye bilgisi varsa createTaskCard'a gönder
                    let taskHtml = createTaskCard(task, assignedMember);
                    
                    if (task.status === 0) {
                        // Todo listesine ekle
                        $("#todo-tasks").append(taskHtml);
                    } else if (task.status === 1) {
                        // In Progress listesine ekle
                        $("#in-progress-tasks").append(taskHtml);
                    } else if (task.status === 2) {
                        // Done listesine ekle
                        $("#done-tasks").append(taskHtml);
                    }
                    
                    // Sayaçları ve tamamlanma yüzdesini güncelle
                    updateTaskCounters();
                    updateCompletionPercentage();
                    
                    // Bildirim göster
                    showNotification("Yeni görev eklendi: " + task.name, "success");
                }
            });
            
            // Görev durumu değiştiğinde
            connection.on("ReceiveTaskStatusChange", function(taskId, newStatus, data) {
                console.log("SignalR: Görev durum değişikliği alındı:", taskId, newStatus, data);
                
                // Ekstra veri varsa ayır
                const task = data ? data.task : null;
                const assignedMember = data ? data.assignedMember : null;
                
                // Görev kartını bul
                const taskCard = $(`.task-card[data-task-id="${taskId}"]`);
                if (taskCard.length > 0) {
                    // Görevi yeni konuma taşı
                    if (newStatus === 0) {
                        const container = $("#todo-tasks");
                        container.append(taskCard);
                    } else if (newStatus === 1) {
                        const container = $("#in-progress-tasks");
                        container.append(taskCard);
                    } else if (newStatus === 2) {
                        const container = $("#done-tasks");
                        container.append(taskCard);
                    }
                    
                    // Görev butonlarını güncelle - updateTaskButtons fonksiyonunu çağır
                    updateTaskButtons(taskCard, newStatus);
                    
                    // Sayaçları ve tamamlanma yüzdesini güncelle
                    updateTaskCounters();
                    updateCompletionPercentage();
                }
            });
            
            // Görev silindiğinde
            connection.on("ReceiveTaskDelete", function(taskId) {
                console.log("SignalR: Görev silme bildirimi alındı:", taskId);
                
                const taskCard = $(`.task-card[data-task-id="${taskId}"]`);
                if (taskCard.length > 0) {
                    taskCard.fadeOut('fast', function() {
                        $(this).remove();
                        updateTaskCounters();
                        updateCompletionPercentage();
                    });
                }
            });
            
            // Görev güncellendiğinde
            connection.on("ReceiveTaskUpdate", function(taskId, data) {
                console.log("SignalR: Görev güncelleme bildirimi alındı:", taskId, data);
                
                // Tekrarlı güncellemeleri önlemek için yardımcı fonksiyonu kullan
                preventDuplicateUpdates(taskId, function() {
                // Veriyi ayır - Şimdi taskForSignalR objesi içinde
                const task = data.task;
                const assignedMember = data.assignedMember;
                
                const taskCard = $(`.task-card[data-task-id="${taskId}"]`);
                if (taskCard.length > 0) {
                        // Görevin mevcut özelliklerini sakla
                        const cardId = taskCard.attr('data-task-id');
                        const statusId = task.status;
                        
                        // Edit ve delete butonlarını klonla
                        const editBtn = taskCard.find('.edit-task-btn').clone(true);
                        const deleteBtn = taskCard.find('.delete-task-btn').clone(true);
                        
                        // Kartı tamamen yeniden oluştur
                        let newCardHtml = `
                            <div class="flex justify-between items-start">
                                <h4 class="font-medium text-gray-800 mb-1">${task.name}</h4>
                                <div class="task-actions ml-2 flex items-center">
                                    <!-- Edit ve delete butonları buraya eklenecek -->
                                </div>
                            </div>
                        `;
                        
                        // Açıklama varsa ekle
                    if (task.description && task.description.trim() !== '') {
                            newCardHtml += `
                                <p class="text-sm text-gray-600 mb-2 break-words whitespace-normal" style="word-wrap: break-word; max-width: 100%; overflow-wrap: break-word;">${task.description}</p>
                            `;
                        }
                        
                        // Öncelik ve tarih bilgilerini ekle
                    const priorityClasses = {
                        0: 'bg-green-100 text-green-800',
                        1: 'bg-blue-100 text-blue-800',
                        2: 'bg-yellow-100 text-yellow-800',
                        3: 'bg-red-100 text-red-800'
                    };
                    const priorityTexts = {
                        0: 'Düşük',
                        1: 'Orta',
                        2: 'Yüksek',
                        3: 'Acil'
                    };
                    
                        newCardHtml += `
                            <div class="flex items-center justify-between mt-2">
                                <span class="px-2 py-1 ${priorityClasses[task.priority]} text-xs rounded-full">${priorityTexts[task.priority]}</span>
                        `;
                        
                        // Tarih varsa ekle
                        if (task.dueDate) {
                            const dueDate = new Date(task.dueDate);
                            const formattedDate = `${dueDate.getDate()} ${['Oca', 'Şub', 'Mar', 'Nis', 'May', 'Haz', 'Tem', 'Ağu', 'Eyl', 'Eki', 'Kas', 'Ara'][dueDate.getMonth()]} ${dueDate.getFullYear()}`;
                            newCardHtml += `
                                <span class="text-xs text-gray-500"><i class="far fa-calendar-alt mr-1"></i>${formattedDate}</span>
                            `;
                        }
                        
                        newCardHtml += `</div>`;
                        
                        // Atanan üye bilgisi varsa ekle
                        if (assignedMember) {
                            const profileImage = assignedMember.userProfileImage || '/images/profiles/default.png';
                            const fullName = assignedMember.userFullName || assignedMember.userName;
                            
                            newCardHtml += `
                                <div class="flex items-center mt-1">
                                    <span class="text-xs text-gray-600 flex items-center">
                                        <img src="${profileImage}" alt="${fullName}" class="w-5 h-5 rounded-full mr-1 border border-gray-200" onerror="this.src='/images/profiles/default.png';">
                                        <span>${fullName}</span>
                                    </span>
                                </div>
                            `;
                        }
                        
                        // Aksiyon butonlarını ekle
                        const canModifyTasks = @canModifyTasks.ToString().ToLower();
                        if (canModifyTasks) {
                            if (statusId === 0) { // Todo
                                newCardHtml += `
                                    <div class="flex space-x-2 mt-2">
                                        <button class="move-task-btn text-xs px-2 py-1 bg-amber-100 text-amber-800 rounded hover:bg-amber-200" data-task-id="${cardId}" data-status="1">
                                            <i class="fas fa-arrow-right"></i> Devam Ediyor
                                        </button>
                                        <button class="move-task-btn text-xs px-2 py-1 bg-green-100 text-green-800 rounded hover:bg-green-200" data-task-id="${cardId}" data-status="2">
                                            <i class="fas fa-arrow-right"></i> Tamamlandı
                                        </button>
                                    </div>
                                `;
                            } else if (statusId === 1) { // In Progress
                                newCardHtml += `
                                    <div class="flex space-x-2 mt-2">
                                        <button class="move-task-btn text-xs px-2 py-1 bg-blue-100 text-blue-800 rounded hover:bg-blue-200" data-task-id="${cardId}" data-status="0">
                                            <i class="fas fa-arrow-left"></i> Yapılacak
                                        </button>
                                        <button class="move-task-btn text-xs px-2 py-1 bg-green-100 text-green-800 rounded hover:bg-green-200" data-task-id="${cardId}" data-status="2">
                                            <i class="fas fa-arrow-right"></i> Tamamlandı
                                        </button>
                                    </div>
                                `;
                            } else if (statusId === 2) { // Done
                                newCardHtml += `
                                    <div class="flex space-x-2 mt-2">
                                        <button class="move-task-btn text-xs px-2 py-1 bg-blue-100 text-blue-800 rounded hover:bg-blue-200" data-task-id="${cardId}" data-status="0">
                                            <i class="fas fa-arrow-left"></i> Yapılacak
                                        </button>
                                        <button class="move-task-btn text-xs px-2 py-1 bg-amber-100 text-amber-800 rounded hover:bg-amber-200" data-task-id="${cardId}" data-status="1">
                                            <i class="fas fa-arrow-left"></i> Devam Ediyor
                                        </button>
                                    </div>
                                `;
                            }
                        }
                        
                        // Görev kartını güncelle
                        taskCard.html(newCardHtml);
                        
                        // Edit ve delete butonlarını yerleştir
                        if (editBtn.length > 0 && deleteBtn.length > 0) {
                            const actionDiv = taskCard.find('.task-actions');
                            actionDiv.append(editBtn).append(deleteBtn);
                        }
                        
                        // Move butonları için event listener'ları yeniden bağla
                        taskCard.find('.move-task-btn').on('click', function() {
                            const taskId = $(this).data('task-id');
                            const newStatus = $(this).data('status');
                            
                            // AJAX ile görev durumunu güncelle
                            $.ajax({
                                url: "@Url.Action("UpdateTaskStatus", "Project")",
                                type: "POST",
                                data: {
                                    taskId: taskId,
                                    newStatus: newStatus
                                },
                                success: function(response) {
                                    if (response.success) {
                                        // İşlem SignalR üzerinden yürütülecek
                                    } else {
                                        showNotification("Hata: " + response.message, "error");
                                    }
                                },
                                error: function() {
                                    showNotification("Bağlantı hatası oluştu", "error");
                                }
                            });
                        });
                    }
                });
            });
            
            // Görev kartında atanmış üye bilgisini güncelleme fonksiyonu
            function updateAssignedMemberInCard(taskCard, assignedMember) {
                console.log("Üye bilgisi güncelleniyor:", assignedMember);
                
                // Önce mevcut tüm atanan üye elementlerini temizle
                taskCard.find('.assigned-member').remove();
                // Diğer olası üye bilgisi sınıflarını da temizle
                taskCard.find('div.flex.items-center.mt-1').remove();
                taskCard.find('div.flex.items-center.mt-2').each(function() {
                    const $this = $(this);
                    // Sadece içinde img.rounded-full olan ve assigned-member sınıfı olmayan divleri bul
                    if ($this.find('img.rounded-full').length > 0 && !$this.hasClass('task-actions')) {
                        $this.remove();
                    }
                });
                
                if (assignedMember) {
                    // Üye bilgisi varsa - Standardize edilmiş şekilde
                    const profileImage = assignedMember.userProfileImage || '/images/profiles/default.png';
                    const fullName = assignedMember.userFullName || assignedMember.userName;
                    
                    // Yeni üye HTML oluştur
                    const memberHtml = `
                        <div class="flex items-center mt-1">
                            <span class="text-xs text-gray-600 flex items-center">
                                <img src="${profileImage}" alt="${fullName}" class="w-5 h-5 rounded-full mr-1 border border-gray-200" onerror="this.src='/images/profiles/default.png';">
                                <span>${fullName}</span>
                            </span>
                        </div>
                    `;
                    
                    // Priority/date div'i bul (sabit selector kullan)
                    const priorityDateDiv = taskCard.find('div.flex.items-center.justify-between');
                    
                    // Aksiyon butonlarını bul (farklı olası selectorlarla)
                    const actionButtons = taskCard.find('div.flex.space-x-2.mt-2, div.flex.justify-between.items-center.mt-2, div.flex.justify-end.items-center.mt-2');
                    
                    // Önce aksiyon butonlarını geçici kaldır
                    let detachedButtons = null;
                    if (actionButtons.length > 0) {
                        detachedButtons = actionButtons.detach();
                    }
                    
                    // Üye bilgisini priority/date div'inden sonra ekle
                    if (priorityDateDiv.length > 0) {
                        priorityDateDiv.after(memberHtml);
                    } else {
                        // Fallback: Doğrudan karta ekle
                        taskCard.append(memberHtml);
                    }
                    
                    // Eğer aksiyon butonları varsa, en sona tekrar ekle
                    if (detachedButtons) {
                        taskCard.append(detachedButtons);
                    }
                }
            }
            
            // Görev kartı oluşturma fonksiyonu
            function createTaskCard(task, assignedMember) {
                // Öncelik metinleri ve sınıfları
                const priorityTexts = {
                    0: 'Düşük',
                    1: 'Orta',
                    2: 'Yüksek',
                    3: 'Acil'
                };
                
                const priorityClasses = {
                    0: 'bg-green-100 text-green-800',
                    1: 'bg-blue-100 text-blue-800',
                    2: 'bg-yellow-100 text-yellow-800',
                    3: 'bg-red-100 text-red-800'
                };
                
                // Açıklama HTML'i (mevcutsa)
                let descriptionHtml = '';
                if (task.description && task.description.trim() !== '') {
                    descriptionHtml = `<p class="text-sm text-gray-600 mb-2 break-words whitespace-normal" style="word-wrap: break-word; max-width: 100%; overflow-wrap: break-word;">${task.description}</p>`;
                }
                
                // Tarih formatı (mevcutsa)
                let dueDateHtml = '';
                if (task.dueDate) {
                    const dueDate = new Date(task.dueDate);
                    dueDateHtml = `<span class="text-xs text-gray-500"><i class="far fa-calendar-alt mr-1"></i>${formatDate(dueDate)}</span>`;
                }
                
                // Atanan üye bilgisi (mevcutsa) - Standardize edilmiş şekilde
                let assignedMemberHtml = '';
                if (assignedMember) {
                    const profileImage = assignedMember.userProfileImage || '/images/profiles/default.png';
                    const fullName = assignedMember.userFullName || assignedMember.userName;
                    assignedMemberHtml = `
                        <div class="flex items-center mt-1">
                            <span class="text-xs text-gray-600 flex items-center">
                                <img src="${profileImage}" alt="${fullName}" class="w-5 h-5 rounded-full mr-1 border border-gray-200" onerror="this.src='/images/profiles/default.png';">
                                <span>${fullName}</span>
                            </span>
                        </div>
                    `;
                }
                
                // Duruma göre aksiyon butonları
                let actionButtons = '';
                if (@(canModifyTasks.ToString().ToLower())) {
                    if (task.status === 0) { // Todo
                        actionButtons = `
                            <div class="flex space-x-2 mt-2">
                                <button class="move-task-btn text-xs px-2 py-1 bg-amber-100 text-amber-800 rounded hover:bg-amber-200" data-task-id="${task.id}" data-status="1">
                                    <i class="fas fa-arrow-right"></i> Devam Ediyor
                                </button>
                                <button class="move-task-btn text-xs px-2 py-1 bg-green-100 text-green-800 rounded hover:bg-green-200" data-task-id="${task.id}" data-status="2">
                                    <i class="fas fa-arrow-right"></i> Tamamlandı
                                </button>
                            </div>
                        `;
                    } else if (task.status === 1) { // In Progress
                        actionButtons = `
                            <div class="flex space-x-2 mt-2">
                                <button class="move-task-btn text-xs px-2 py-1 bg-blue-100 text-blue-800 rounded hover:bg-blue-200" data-task-id="${task.id}" data-status="0">
                                    <i class="fas fa-arrow-left"></i> Yapılacak
                                </button>
                                <button class="move-task-btn text-xs px-2 py-1 bg-green-100 text-green-800 rounded hover:bg-green-200" data-task-id="${task.id}" data-status="2">
                                    <i class="fas fa-arrow-right"></i> Tamamlandı
                                </button>
                            </div>
                        `;
                    } else if (task.status === 2) { // Done
                        actionButtons = `
                            <div class="flex space-x-2 mt-2">
                                <button class="move-task-btn text-xs px-2 py-1 bg-blue-100 text-blue-800 rounded hover:bg-blue-200" data-task-id="${task.id}" data-status="0">
                                    <i class="fas fa-arrow-left"></i> Yapılacak
                                </button>
                                <button class="move-task-btn text-xs px-2 py-1 bg-amber-100 text-amber-800 rounded hover:bg-amber-200" data-task-id="${task.id}" data-status="1">
                                    <i class="fas fa-arrow-left"></i> Devam Ediyor
                                </button>
                            </div>
                        `;
                    }
                }
                
                return `
                    <div class="task-card bg-white rounded-lg border border-gray-200 p-3 shadow-sm hover:shadow-md transition-shadow duration-200 cursor-grab active:cursor-grabbing" data-task-id="${task.id}">
                        <div class="flex justify-between items-start">
                            <h4 class="font-medium text-gray-800 mb-1">${task.name}</h4>
                            @if (canModifyTasks.ToString().ToLower() == "true") {
                                <text>
                                <div class="task-actions ml-2 flex items-center">
                                    <button class="edit-task-btn text-blue-500 hover:text-blue-700 mr-2" data-task-id="${task.id}">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button class="delete-task-btn text-red-500 hover:text-red-700" data-task-id="${task.id}">
                                        <i class="fas fa-trash-alt"></i>
                                    </button>
                                </div>
                                </text>
                            }
                        </div>
                        ${descriptionHtml}
                        <div class="flex items-center justify-between mt-2">
                            <span class="px-2 py-1 ${priorityClasses[task.priority]} text-xs rounded-full">${priorityTexts[task.priority]}</span>
                            ${dueDateHtml}
                        </div>
                        ${assignedMemberHtml}
                        ${actionButtons}
                    </div>
                `;
            }
            
            // Takım üyesinin adını ID'ye göre almak için yardımcı fonksiyon
            function getTeamMemberName(userId) {
                const teamMembers = @Html.Raw(Json.Serialize(Model.TeamMembers));
                const member = teamMembers.find(m => m.UserId === userId);
                return member ? member.UserName : "Atanmamış";
            }
            
            // Takım üyesinin tam adını ID'ye göre almak için yardımcı fonksiyon
            function getTeamMemberFullName(userId) {
                const teamMembers = @Html.Raw(Json.Serialize(Model.TeamMembers));
                const member = teamMembers.find(m => m.UserId === userId);
                return member ? member.UserFullName : "Atanmamış";
            }
            
            // Takım üyesinin profil resmini ID'ye göre almak için yardımcı fonksiyon
            function getTeamMemberProfileImage(userId) {
                const teamMembers = @Html.Raw(Json.Serialize(Model.TeamMembers));
                const member = teamMembers.find(m => m.UserId === userId);
                return member ? member.UserProfileImage : "/images/profiles/default.png";
            }
            
            // Görev sayaçlarını güncelleme fonksiyonu
            function updateTaskCounters() {
                // Her bir durum için görev sayısını güncelle
                const todoCount = $('#todo-tasks .task-card').length;
                const inProgressCount = $('#in-progress-tasks .task-card').length;
                const doneCount = $('#done-tasks .task-card').length;
                
                // Sayaçları güncelle - daha spesifik seçicilerle
                $('.todo-count-badge').text(todoCount);
                $('.in-progress-count-badge').text(inProgressCount);
                $('.done-count-badge').text(doneCount);
                
                // Sayıları konsola yazdır (debug amaçlı)
                console.log("Görev sayıları güncellendi:", { todo: todoCount, inProgress: inProgressCount, done: doneCount });
            }
            
            // Tamamlanma yüzdesini güncelleme fonksiyonu
            function updateCompletionPercentage() {
                // Görev sayılarını al
                const todoCount = $('#todo-tasks .task-card').length;
                const inProgressCount = $('#in-progress-tasks .task-card').length;
                const doneCount = $('#done-tasks .task-card').length;
                
                // Toplam görev sayısı
                const totalTasks = todoCount + inProgressCount + doneCount;
                
                // Eğer hiç görev yoksa, yüzde 0 olarak ayarla
                if (totalTasks === 0) {
                    setCompletionBar(0);
                    return;
                }
                
                // Tamamlanma yüzdesini hesapla (sadece Done durumundaki görevler tamamlanmış sayılır)
                const completionPercentage = Math.round((doneCount / totalTasks) * 100);
                
                // İlerleme çubuğunu güncelle
                setCompletionBar(completionPercentage);
            }
            
            // İlerleme çubuğunu ayarlama fonksiyonu
            function setCompletionBar(percentage) {
                // İlerleme çubuğu elementini seç
                const progressBar = $('.bg-primary-500.h-2.rounded-full');
                const percentageText = progressBar.parent().next('.text-sm.text-gray-500');
                
                // Genişliği güncelle
                progressBar.css('width', percentage + '%');
                
                // Yüzde metnini güncelle
                percentageText.text('%' + percentage);
            }
            
            // Bildirim gösterme fonksiyonu
            function showNotification(message, type) {
                const notificationDiv = $('<div>').addClass('fixed bottom-4 right-4 px-6 py-3 rounded-lg shadow-lg z-50')
                    .css('transition', 'all 0.5s ease')
                    .css('opacity', '0')
                    .text(message);
                
                if (type === 'success') {
                    notificationDiv.addClass('bg-green-500 text-white');
                } else {
                    notificationDiv.addClass('bg-red-500 text-white');
                }
                
                $('body').append(notificationDiv);
                
                // Animasyon ile göster
                setTimeout(() => {
                    notificationDiv.css('opacity', '1');
                }, 10);
                
                // 3 saniye sonra kaldır
                setTimeout(() => {
                    notificationDiv.css('opacity', '0');
                    setTimeout(() => {
                        notificationDiv.remove();
                    }, 500);
                }, 3000);
            }
            
            // Öncelik değerini metne dönüştüren fonksiyon
            function getPriorityText(priority) {
                switch(parseInt(priority)) {
                    case 0: return "Düşük";
                    case 1: return "Orta";
                    case 2: return "Yüksek";
                    case 3: return "Acil";
                    default: return "Orta";
                }
            }

            // Öncelik değerine göre stil sınıflarını döndüren fonksiyon
            function getPriorityClasses(priority) {
                switch(parseInt(priority)) {
                    case 0: return "bg-green-100 text-green-800";
                    case 1: return "bg-blue-100 text-blue-800";
                    case 2: return "bg-yellow-100 text-yellow-800";
                    case 3: return "bg-red-100 text-red-800";
                    default: return "bg-gray-100 text-gray-800";
                }
            }
            
            // Tarih formatı fonksiyonu
            function formatDate(dateString) {
                if (!dateString) return '';
                const date = new Date(dateString);
                const day = date.getDate().toString().padStart(2, '0');
                const month = date.toLocaleString('tr-TR', { month: 'short' });
                const year = date.getFullYear();
                return `${day} ${month} ${year}`;
            }

            // Görev silme butonuna tıklandığında
            $(document).on('click', '.delete-task-btn', function() {
                const taskId = $(this).data('task-id');
                $('#delete-task-id').val(taskId);
                $('#delete-task-modal').removeClass('hidden');
                $('body').css('overflow', 'hidden');
            });
            
            // Görev düzenleme butonuna tıklandığında
            $(document).on('click', '.edit-task-btn', function() {
                console.log("Edit task button clicked");
                const taskId = $(this).data("task-id");
                console.log("Task ID:", taskId);
                
                // Görevi Ajax ile getir
                $.ajax({
                    url: "@Url.Action("GetTask", "Project")",
                    type: "GET",
                    data: { taskId: taskId },
                    success: function(task) {
                        if (task) {
                            console.log("Görev verisi alındı:", task);
                            
                            // Modal alanlarını doldur
                            $("#edit-task-id").val(task.id);
                            $("#edit-task-project-id").val(task.projectId);
                            $("#edit-task-status").val(task.status);
                            $("#edit-task-name").val(task.name);
                            $("#edit-task-description").val(task.description);
                            $("#edit-task-priority").val(task.priority);
                            
                            // Bitiş tarihi varsa formatla ve ata
                            if (task.dueDate) {
                                const dueDate = new Date(task.dueDate);
                                $("#edit-task-due-date").val(dueDate.toISOString().split('T')[0]);
                            } else {
                                $("#edit-task-due-date").val('');
                            }
                            
                            // Atanan üye seçimini güncelle
                            console.log("Atanan üye ID:", task.assignedMemberId);
                            
                            // Mevcut tüm takım üyelerini getir
                            const teamMembers = @Html.Raw(Json.Serialize(Model.TeamMembers));
                            
                            // Atanan üye ID'sini düzgün şekilde handle et
                            if (task.assignedMemberId && task.assignedMemberId !== "") {
                                console.log("Atanacak üye ID değeri:", task.assignedMemberId, "Tip:", typeof task.assignedMemberId);
                                
                                // Tüm seçenekleri kontrol et ve veri özniteliği eşleşeni bul
                                let optionFound = false;
                                
                                // Öncelikle tüm seçenek değerlerini string olarak karşılaştır
                                const assignedIdStr = String(task.assignedMemberId);
                                
                                // Forma üye ID değerini doğrudan atamayı dene
                                $("#edit-task-assigned-member").val(assignedIdStr);
                                
                                // Atama başarılı mı kontrol et
                                if ($("#edit-task-assigned-member").val() === assignedIdStr) {
                                    console.log(`Doğrudan atama başarılı: ${assignedIdStr}`);
                                    optionFound = true;
                                } else {
                                    console.log("Doğrudan atama başarısız, alternatif yöntemler deneniyor");
                                    
                                    // Her option için kontrol
                                    Array.from(selectElement.options).forEach(option => {
                                        const optionVal = String(option.value);
                                        const optionUserId = String(option.getAttribute('data-user-id') || "");
                                        
                                        console.log(`Karşılaştırma: 
                                            option.value (${typeof optionVal}) = ${optionVal} 
                                            vs 
                                            assignedIdStr (${typeof assignedIdStr}) = ${assignedIdStr}`);
                                            
                                        console.log(`Kullanıcı ID Karşılaştırma: 
                                            option.data-user-id (${typeof optionUserId}) = ${optionUserId} 
                                            vs 
                                            assignedIdStr (${typeof assignedIdStr}) = ${assignedIdStr}`);
                                        
                                        // Değer veya kullanıcı ID eşleşmesi
                                        if (optionVal === assignedIdStr || optionUserId === assignedIdStr) {
                                            option.selected = true;
                                            $("#edit-task-assigned-member").val(optionVal);
                                            optionFound = true;
                                            console.log(`Eşleşen seçenek bulundu: ${optionVal}`);
                                        }
                                    });
                                }
                                
                                if (!optionFound) {
                                    console.log("Eşleşen seçenek bulunamadı, boş değer atanıyor");
                                    $("#edit-task-assigned-member").val("");
                                }
                            } else {
                                // Atanmış üye yoksa boş seç
                                console.log("Atanmış üye bilgisi yok, boş değer atanıyor");
                                $("#edit-task-assigned-member").val("");
                            }
                            
                            // Modalı göster
                            $("#edit-task-modal").removeClass("hidden");
                $("body").css("overflow", "hidden");
                            } else {
                                showNotification("Görev bilgileri alınamadı", "error");
                            }
                        },
                        error: function() {
                            showNotification("Bağlantı hatası oluştu", "error");
                        }
                    });
                });
                
                // Görev düzenleme modalını kapatma
                $("#close-edit-task-modal, #cancel-edit-task").on("click", function() {
                    $("#edit-task-modal").addClass("hidden");
                    $("body").css("overflow", "");
                    $("#edit-task-form")[0].reset();
                });
                
                // Form submit olayını engelle ve sadece buton click olayını kullan
                $("#edit-task-form").on("submit", function(e) {
                    e.preventDefault(); // Form submiti engelle
                    return false;
                });
                
                // Görev düzenleme formunu gönder
                $("#edit-task-form").on("submit", function(e) {
                    e.preventDefault();
                    
                    const taskId = $("#edit-task-id").val();
                    const projectId = $("#edit-task-project-id").val();
                    const status = $("#edit-task-status").val();
                    const name = $("#edit-task-name").val();
                    const description = $("#edit-task-description").val();
                    const priority = $("#edit-task-priority").val();
                    const dueDate = $("#edit-task-due-date").val();
                    const assignedMemberId = $("#edit-task-assigned-member").val();
                    
                    if (!name || name.trim() === "") {
                        showNotification("Görev adı zorunludur", "error");
                        return false;
                    }
                    
                    // Görevi Ajax ile güncelle
                    $.ajax({
                        url: "@Url.Action("UpdateTask", "Project")",
                        type: "POST",
                        data: {
                            Id: taskId,
                            ProjectId: projectId,
                            Status: status,
                            Name: name,
                            Description: description,
                            Priority: priority,
                            DueDate: dueDate,
                            AssignedMemberId: assignedMemberId
                        },
                        success: function(response) {
                            if (response.success) {
                                // Modalı kapat
                                $("#edit-task-modal").addClass("hidden");
                                $("body").css("overflow", "");
                                
                                // Kullanıcıya bilgi ver
                                showNotification("Görev başarıyla güncellendi", "success");
                                
                                // Sayfa yenileme yapmadan dinamik olarak görevi güncelle
                                const taskCard = $(`.task-card[data-task-id="${taskId}"]`);
                                const task = response.task;
                                
                                // Basit alanları güncelle
                                taskCard.find('h4').text(task.name);
                                
                                // Açıklama alanını güncelle
                                let descriptionElement = taskCard.find('p.text-sm.text-gray-600.mb-2');
                                if (task.description) {
                                    if (descriptionElement.length === 0) {
                                        taskCard.find('div.flex.justify-between.items-start').after(
                                            `<p class="text-sm text-gray-600 mb-2 break-words whitespace-normal" style="word-wrap: break-word; max-width: 100%; overflow-wrap: break-word;">${task.description}</p>`
                                        );
                        } else {
                                    descriptionElement.text(task.description);
                                }
                            } else if (descriptionElement.length > 0) {
                                descriptionElement.remove();
                            }
                            
                            // Önceliği güncelle
                            const prioritySpan = taskCard.find('span.rounded-full').first();
                            const priorityClasses = {
                                0: 'bg-blue-100 text-blue-800',
                                1: 'bg-amber-100 text-amber-800',
                                2: 'bg-orange-100 text-orange-800',
                                3: 'bg-red-100 text-red-800'
                            };
                            const priorityTexts = {
                                0: 'Düşük',
                                1: 'Orta',
                                2: 'Yüksek',
                                3: 'Acil'
                            };
                            
                            prioritySpan.removeClass('bg-blue-100 text-blue-800 bg-amber-100 text-amber-800 bg-orange-100 text-orange-800 bg-red-100 text-red-800');
                            prioritySpan.addClass(priorityClasses[task.priority]);
                            prioritySpan.text(priorityTexts[task.priority]);
                            
                            // Görev atanmış kişiyi güncelle
                            // Bu kısmı daha karmaşık olduğu için şimdilik sayfayı yenileme şeklinde ele alalım
                            // Daha sonra iyileştirmek için bu bölüm geliştirilebilir
                            
                            // Formu sıfırla
                            $("#edit-task-form")[0].reset();
                        } else {
                            showNotification("Hata: " + response.message, "error");
                        }
                    },
                    error: function() {
                        showNotification("Bağlantı hatası oluştu", "error");
                    }
                });
            });

            // Görev düzenleme modalı için düğme işleyicileri
            $("#edit-task-save-btn").on("click", function() {
                console.log("Save button clicked");
                
                // Form değerlerini al ve ekrana yazdır (debug için)
                const taskId = $("#edit-task-id").val();
                const projectId = $("#edit-task-project-id").val();
                const status = $("#edit-task-status").val();
                const name = $("#edit-task-name").val();
                const description = $("#edit-task-description").val();
                const priority = $("#edit-task-priority").val();
                const dueDate = $("#edit-task-due-date").val();
                const assignedMemberId = $("#edit-task-assigned-member").val();
                
                // Tüm form verilerini logla
                console.log("FORM VERİLERİ:", {
                    Id: taskId,
                    ProjectId: projectId,
                    Status: status,
                    Name: name,
                    Description: description,
                    Priority: priority,
                    DueDate: dueDate,
                    AssignedMemberId: assignedMemberId
                });
                
                if (!name || name.trim() === "") {
                    showNotification("Görev adı zorunludur", "error");
                    return false;
                }
                
                // Görevi Ajax ile güncelle - Form datayı manuel olarak gönderelim
                $.ajax({
                    url: "@Url.Action("UpdateTask", "Project")",
                    type: "POST",
                    contentType: "application/json",
                    data: JSON.stringify({
                        Id: parseInt(taskId),
                        ProjectId: parseInt(projectId),
                        Status: parseInt(status),
                        Name: name,
                        Description: description,
                        Priority: parseInt(priority),
                        DueDate: dueDate ? new Date(dueDate) : null,
                        AssignedMemberId: assignedMemberId
                    }),
                    success: function(response) {
                        console.log("Sunucu yanıtı:", response);
                        
                        if (response.success) {
                            // Modalı kapat
                            $("#edit-task-modal").addClass("hidden");
                            $("body").css("overflow", "");
                            
                            // Kullanıcıya bilgi ver
                            showNotification("Görev başarıyla güncellendi", "success");
                            
                            // Sayfayı yenile (assigned member gösterimi için)
                            window.location.reload();
                        } else {
                            showNotification("Görev güncellenirken bir hata oluştu: " + (response.message || "Bilinmeyen hata"), "error");
                        }
                    },
                    error: function(xhr, status, error) {
                        console.error("Görev güncelleme hatası:", xhr.responseText);
                        showNotification("Bağlantı hatası oluştu. Lütfen tekrar deneyin.", "error");
                    }
            });
        });

        // Sayfadan ayrılırken bağlantıyı kapat
        $(window).on('beforeunload', function() {
            if (connection && connection.state === "Connected") {
                connection.invoke("LeaveProjectGroup", @Model.Project.Id);
                connection.stop();
            }
            });

            // Sayfa yüklendiğinde sayaçları güncelle
            updateTaskCounters();
            updateCompletionPercentage();
        });
    </script>
} 